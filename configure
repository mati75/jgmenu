#!/bin/sh

config_mk="config.mk"
enable_asan=f
prefix="/usr/local"
with_xfce4_panel_applet=f
with_gtktheme=f
with_lx=f
with_pmenu=f

usage_message="Usage: ./configure
Produce a config.mk file to be sourced by Makefile
--with-xfce4-panel-applet  Include xfce4-panel-applet. This has quite different
                           runtime dependencies, so consider building
			   separately.
--with-gtktheme            Include gtktheme module
--with-lx                  Include lx module
--with-pmenu               Include pmenu module
--all, -a                  Include all contrib/ packages above
--enable-asan              Enable address sanitizer (only during development)
--prefix=<dir>             Install architecture-independent files in \$prefix
                           (e.g. --prefix=\$HOME')
"

add () {
	printf '%b\n' "$*" >>"$config_mk"
}

check_required_bins () {
	if ! type "$*" >/dev/null 2>&1; then
		printf '%b\n' "[FAIL] cannot find $*"
		exit 1
	else
		printf '%b\n' "[ OK ] $*"
	fi
}

check_required_libs () {
	if ! pkg-config "$*" >/dev/null 2>&1; then
		printf '%b\n' "[FAIL] cannot find $*"
		exit 1
	else
		printf '%b\n' "[ OK ] $*"
	fi
}

add_modules () {
	add "prefix = $prefix"
	if [ "$enable_asan" = "t" ]; then
		add "ASAN=1"
	fi
	if [ "$with_xfce4_panel_applet" = "t" ]; then
		check_required_libs "libxfce4panel-1.0"
		add "CONTRIB_DIRS += xfce4-panel"
	fi
	if [ "$with_gtktheme" = "t" ]; then
		add "CONTRIB_DIRS += gtktheme"
	fi
	if [ "$with_lx" = "t" ]; then
		check_required_libs "libmenu-cache >= 1.1.0"
		add "CONTRIB_DIRS += lx"
	fi
	if [ "$with_pmenu" = "t" ]; then
		add "CONTRIB_DIRS += pmenu"
	fi
}

check_core_dependencies () {
	check_required_bins "pkg-config"
	check_required_bins "xml2-config"
	check_required_libs "x11"
	check_required_libs "xrandr"
	check_required_libs "cairo"
	check_required_libs "pango"
	check_required_libs "pangocairo"
	check_required_libs "librsvg-2.0"
	check_required_libs "glib-2.0"
}

main () {
	for arg
	do
		opt=${arg%%=*}
		var=${arg#*=}
		case "$opt" in
		--prefix)
			prefix="$var" ;;
		--with-xfce4-panel-applet)
			with_xfce4_panel_applet=t ;;
		--with-gtktheme)
			with_gtktheme=t ;;
		--with-lx)
			with_lx=t ;;
		--with-pmenu)
			with_pmenu=t ;;
		--enable-asan)
			enable_asan=t ;;
		-a|--all)
			with_xfce4_panel_applet=t
			with_gtktheme=t
			with_lx=t
			with_pmenu=t
			;;
		-h|--help)
			printf '%b' "$usage_message"; exit 1 ;;
		*)
			printf '%b\n' "warn: unknown option $opt" >&2 ;;
		esac
	done

	rm -rf $config_mk
	add "# Generated by configure script"
	check_core_dependencies
	add_modules
}

main "$@"
